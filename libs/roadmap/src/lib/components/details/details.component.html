<ion-header mode="md">
  <ion-toolbar>
    <header *ngIf="canEdit">
      <ion-button fill="clear" disabled color="primary">
        <ng-container *ngIf="form?.dirty; else saved">
          <span>SAVING...</span>
        </ng-container>
        <ng-template #saved>
          <span>SAVED</span>
          <ion-icon name="checkmark-outline" slot="end"></ion-icon>
        </ng-template>
      </ion-button>
    </header>

    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" color="primary">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <main>
    <section class="main">
      <form [formGroup]="form">
        <ion-item class="main" lines="none">
          <ion-button (click)="updateStatus()" fill="clear" [disabled]="!canEdit" [ngClass]="{'fake-enable': !canEdit}">
            <strive-milestone-status [milestone]="milestone"></strive-milestone-status>
          </ion-button>
          <ion-textarea autoGrow [readonly]="!canEdit" formControlName="content" placeholder="Type milestone" autocapitalize="sentences"></ion-textarea>
        </ion-item>
      </form>
    </section>

    <section *ngIf="milestone.deadline">
      <div (click)="openDatepicker()" class="deadline" [ngClass]="{'clickable': canEdit}">
        <ion-icon name="alarm-outline"></ion-icon>
        <small>{{ milestone.deadline | date: 'MMM d, y' }}</small>
      </div>
    </section>

    <section *ngIf="milestone.achiever?.uid">
      <small class="assignee">
        <ion-icon name="person-outline"></ion-icon>
        <ion-button class="contrast" size="small" [disabled]="!canEdit" [ngClass]="{'fake-enable': !canEdit}">
          <strive-milestone-assignee [achiever]="milestone.achiever!" (click)="toggleAssignMe()"></strive-milestone-assignee>
        </ion-button>
      </small>
    </section>

    <section *ngIf="milestone.description || showDescription" class="description">
      <small>
        <ion-icon name="reorder-four-outline"></ion-icon>
        <ion-textarea
          [formControl]="form.description"
          placeholder="Description"
          autocapitalize="sentences"
          [maxlength]="200"
          autoGrow
          [readonly]="!canEdit"
        ></ion-textarea>
      </small>
    </section>
    

    <section class="details" *ngIf="canEdit">

      <ion-button (click)="deleteMilestone()" class="danger" size="small">
        <ion-icon slot="icon-only" name="trash-outline" size="small"></ion-icon>
      </ion-button>

      <ng-container *ngIf="!milestone.deadline">
        <ion-button (click)="openDatepicker()" class="primary" size="small">
          <ion-icon name="alarm-outline" slot="start"></ion-icon>
          <span>Deadline</span>
        </ion-button>
      </ng-container>

      <ng-container *ngIf="goal.numberOfAchievers > 1 && !milestone.achiever?.uid">
        <ion-button (click)="toggleAssignMe()" class="primary" size="small">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <span>Assign me</span>
        </ion-button>
      </ng-container>

      <ng-container *ngIf="!showDescription && !milestone.description">
        <ion-button (click)="showDescription = true" class="primary" size="small">
          <ion-icon name="reorder-four-outline" slot="start"></ion-icon>
          <span>Description</span>
        </ion-button>
      </ng-container>

    </section>

    <section *ngIf="canEdit || milestone.subtasks?.length" class="subtasks">
      <header>
        <h6>Subtasks</h6>
        <small>({{ form.subtasks.value | subtasksCompleted}})</small>
      </header>
      <ion-list mode="md" lines="full">
        <ion-reorder-group (ionItemReorder)="doReorder($event)" [disabled]="!canEdit">
          <ion-item *ngFor="let control of form.subtasks.controls; let i = index">
            <ion-button fill="clear" (click)="toggleSubtask(i)">
              <ion-icon  slot="icon-only"
                [name]="control.completed.value ? 'checkmark-circle' : 'radio-button-off'"
                color="primary">
              </ion-icon>
            </ion-button>
            <ion-input [readonly]="!canEdit" [formControl]="control.content" autocapitalize="sentences" (ionBlur)="subtaskBlur(i)"></ion-input>
            <ion-reorder slot="end"></ion-reorder>
          </ion-item>
        </ion-reorder-group>
        
        <form [formGroup]="subtaskForm" *ngIf="canEdit">
          <ion-item lines="none">
            <ion-icon class="icon" name="radio-button-off" color="primary"></ion-icon>
            <ion-input formControlName="content" placeholder="Add subtask" (keydown.enter)="addSubtask()" autocapitalize="sentences"></ion-input>
            <ion-button color="primary" (click)="addSubtask()">add</ion-button>
          </ion-item>
        </form>
      </ion-list>
    </section>

    <section class="supports">
      <h6>Supports</h6>

      <ng-container *ngIf="milestone.status === 'pending'">
        <strive-support-add [goal]="goal" [milestone]="milestone"></strive-support-add>
      </ng-container>

      <ng-container *ngIf="supports$ | async as supports">
        <strive-support-list [goal]="supports[0]">
          <ng-container *ngIf="milestone.status === 'pending'">
            <ng-template #empty>
              <i>No supports yet</i>
            </ng-template>
          </ng-container>
        </strive-support-list>
      </ng-container>
    </section>

    <ng-container *ngIf="story$ | async as story">
      <section *ngIf="canEdit || story.length">
        <h6>Story</h6>
        <strive-story [story]="story" [stakeholder]="stakeholder" [goalId]="goal.id" [milestoneId]="milestone.id"></strive-story>
      </section>
    </ng-container>

    <!-- <small><b>Created at:</b> {{ milestone.createdAt | date:'longDate' }}</small>
    <small *ngIf="milestone.finishedAt">
      <b>Finished at:</b> {{ milestone.finishedAt | date:'longDate' }}
    </small> -->

  </main>
</ion-content>

