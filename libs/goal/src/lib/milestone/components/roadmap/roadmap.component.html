<ng-container *ngIf="milestones else loading">
  <ng-container *ngIf="milestones.length || canEdit else empty">
    <ion-list mode="md">
    
      <ion-reorder-group [disabled]="!canEdit" (ionItemReorder)="doReorder($event)">
        <ion-item *ngFor="let milestone of milestones; trackBy: trackByFn" (click)="openDetails(milestone)" button class="milestone" [ngClass]="{'no-padding': !createMode}">
          <ion-button *ngIf="!createMode" (click)="updateStatus(milestone, $event)" fill="clear" slot="start" class="status-button" [disabled]="!canEdit" [ngClass]="{'fake-enable': !canEdit}">
            <goal-milestone-status slot="icon-only" [milestone]="milestone"></goal-milestone-status>
          </ion-button>
          <section>
            <span>{{ milestone.content }}</span>
            <small class="description" *ngIf="milestone.description">{{ milestone.description | maxLength:100 }}</small>
            <article *ngIf="(canEdit && !createMode) || milestone.subtasks?.length || milestone.deadline || milestone.achieverId">
              <ng-container *ngIf="canEdit && !createMode">
                <div class="supports">
                  <small><ion-icon src="assets/icons/hand-holding-heart-outline.svg"></ion-icon>{{ milestone.supports?.length ?? 0 }}</small>
                </div>
              </ng-container>
              <ng-container *ngIf="milestone.subtasks?.length">
                <div class="subtasks">
                  <ion-icon name="list-outline"></ion-icon><small>{{ milestone.subtasks | subtasksCompleted }}</small>
                </div>
              </ng-container>
              <ng-container *ngIf="milestone.deadline">
                <div class="deadline">
                  <ion-icon name="alarm-outline"></ion-icon>
                  <small>{{ milestone.deadline | date:'MMM d, y' }}</small>
                </div>
              </ng-container>
              <ng-container *ngIf="milestone.achiever?.uid">
                <goal-milestone-assignee [achiever]="milestone.achiever!"></goal-milestone-assignee>
              </ng-container>
            </article>
          </section>
          <ng-container *ngIf="!canEdit">
            <ion-button slot="end" size="small" color="secondary" [disabled]="milestone.status !== 'pending'" (click)="openSupportModal($event, milestone)">{{ milestone.supports?.length ?? 0 }}
              <ion-icon src="assets/icons/hand-holding-heart-solid.svg" slot="end"></ion-icon>
            </ion-button>
          </ng-container>
          <ion-reorder slot="end"></ion-reorder>
        </ion-item>
      </ion-reorder-group>
      
      <form [formGroup]="milestoneForm" *ngIf="canEdit">
        <ion-item lines="none" [ngClass]="{'no-padding': !createMode}">
          <ion-button *ngIf="!createMode" fill="clear" slot="start" disabled class="status-button fake-enable">
            <goal-milestone-status slot="icon-only"></goal-milestone-status>
          </ion-button>
          <ion-input formControlName="content" placeholder="Add milestone" (keydown.enter)="add()" autocapitalize="sentences"></ion-input>
          <ion-button color="primary" (click)="add()">add</ion-button>
        </ion-item>
      </form>
    </ion-list>
  </ng-container>
</ng-container>

<ng-template #empty>
  <img asset='theo-crossroad-square.svg'/>
</ng-template>

<ng-template #loading>
  <ion-list>
    <ion-item *ngFor="let i of [].constructor(5)">
      <ion-button fill="clear" slot="start" disabled class="status-button fake-enable">
        <goal-milestone-status slot="icon-only"></goal-milestone-status>
      </ion-button>

      <section class="skeleton">
        <ion-skeleton-text [animated]="true" style="width: 80%;"></ion-skeleton-text>
        <article>
          <ion-skeleton-text [animated]="true" style="width: 20%;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 30%;"></ion-skeleton-text>
        </article>
      </section>
    </ion-item>
  </ion-list>
</ng-template>