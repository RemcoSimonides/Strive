<ion-header mode="md">
  <ion-toolbar>
    <header *ngIf="canEdit">
      <ion-button fill="clear" disabled color="primary">
        <ng-container *ngIf="form?.dirty; else saved">
          <span>SAVING...</span>
        </ng-container>
        <ng-template #saved>
          <span>SAVED</span>
          <ion-icon name="checkmark-outline" slot="end"></ion-icon>
        </ng-template>
      </ion-button>
    </header>

    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" color="primary">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <section fxLayout="column" fxLayoutGap="8px" class="ion-padding">
    <h5>Milestone</h5>
    <form [formGroup]="form">
      <ion-item class="main">
        <strive-milestone-status [goal]="goal" [milestone]="milestone" [isAdmin]="isAdmin" [isAchiever]="isAchiever"></strive-milestone-status>
        <ion-textarea autoGrow [readonly]="!isAdmin" formControlName="content" placeholder="Type milestone" autocapitalize="sentences"></ion-textarea>
        <ion-button *ngIf="canEdit" fill="clear" slot="end" (click)="deleteMilestone()">
          <ion-icon slot="icon-only" name="trash"></ion-icon>
        </ion-button>
      </ion-item>
    </form>

    <article fxLayout>
      <b>Deadline:</b>
      <strive-milestone-deadline [milestone]="milestone" [isAdmin]="isAdmin" (deadlineChange)="updateDeadline($event)"></strive-milestone-deadline>
    </article>
    
    <ng-container *ngIf="goal.numberOfAchievers > 1">
      <div fxLayout fxLayoutGap="8px" *ngIf="canEdit || milestone.achiever.uid">
        <b>Assignee:</b>
        <ng-container *ngIf="milestone.achiever.uid else empty">
          <goal-milestone-assignee [achiever]="milestone.achiever" (click)="toggleAssignMe()" [ngClass]="{'clickable': canEdit}"></goal-milestone-assignee>
        </ng-container>
        <ng-template #empty>
          <i (click)="toggleAssignMe()" [ngClass]="{'clickable': canEdit}">No one - Assign me</i>
        </ng-template>
      </div>
    </ng-container>

    <div fxLayout="row wrap" fxLayoutAlign="space-between">
      <span><b>Supports: </b>{{ milestone.supports?.length }}</span>

      <ion-button (click)="openSupportModal()" color="secondary" fill="outline">
        <ion-icon slot="start" src="assets/icons/hand-holding-heart-solid.svg"></ion-icon>
        <span>{{ milestone.status === 'pending' ? 'SUPPORT' : 'SHOW SUPPORTS'}}</span>
      </ion-button>
    </div>

    <article class="description">
      <ng-container *ngIf="!isAdmin else editable">
        <ng-container *ngIf="milestone.description">
          <h5>Description</h5>
          <article>{{ milestone.description }}</article>
        </ng-container>
      </ng-container>
      <ng-template #editable>
        <h5>Description</h5>
        <ion-item>
          <ion-textarea [formControl]="form.description" placeholder="..." autocapitalize="sentences" [maxlength]="200" autoGrow></ion-textarea>
        </ion-item>
      </ng-template>
    </article>

    <ng-container *ngIf="isAdmin || milestone.subtasks?.length">
      <h5>Subtasks ({{ form.subtasks.value | subtasksCompleted}})</h5>
      <ion-list mode="md">
        <ion-reorder-group (ionItemReorder)="doReorder($event)" [disabled]="!isAdmin">
          <ion-item *ngFor="let control of form.subtasks.controls; let i = index">
            <ion-button fill="clear" (click)="toggleSubtask(i)">
              <ion-icon  slot="icon-only"
                [name]="control.completed.value ? 'checkmark-circle' : 'radio-button-off'"
                color="primary">
              </ion-icon>
            </ion-button>
            <ion-input [readonly]="!isAdmin" [formControl]="control.content" autocapitalize="sentences"></ion-input>
            <ion-reorder slot="end"></ion-reorder>
          </ion-item>
        </ion-reorder-group>
        
        <form [formGroup]="subtaskForm" *ngIf="isAdmin">
          <ion-item lines="none">
            <ion-icon class="icon" name="radio-button-off" color="primary"></ion-icon>
            <ion-input formControlName="content" placeholder="Add subtask" (keydown.enter)="addSubtask()" autocapitalize="sentences"></ion-input>
            <ion-button (click)="addSubtask()">add</ion-button>
          </ion-item>
        </form>
      </ion-list>
    </ng-container>

    <ng-container *ngIf="story$ | async as story">
      <ng-container *ngIf="isAdmin || story.length">
        <h5>Story</h5>
        <goal-story [story]="story" [isAdmin]="isAdmin" [goalId]="goal.id" [milestoneId]="milestone.id"></goal-story>
      </ng-container>
    </ng-container>

    <!-- <small><b>Created at:</b> {{ milestone.createdAt | date:'longDate' }}</small>
    <small *ngIf="milestone.finishedAt">
      <b>Finished at:</b> {{ milestone.finishedAt | date:'longDate' }}
    </small> -->

  </section>
</ion-content>

