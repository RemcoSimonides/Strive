<ion-header mode="md">
  <ion-toolbar>
    <header *ngIf="canEdit">
      <ion-button fill="clear" disabled color="primary">
        <ng-container *ngIf="form?.dirty; else saved">
          <span>SAVING...</span>
        </ng-container>
        <ng-template #saved>
          <span>SAVED</span>
          <ion-icon name="checkmark-outline" slot="end"></ion-icon>
        </ng-template>
      </ion-button>
    </header>

    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" color="primary">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <main>
    <section class="main">
      <header>
        <h5>Milestone</h5>
        <ion-button *ngIf="canEdit" color="danger" fill="clear" slot="end" size="small" (click)="deleteMilestone()">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-button>
      </header>
      <form [formGroup]="form">
        <ion-item class="main" lines="none">
          <goal-milestone-status [goal]="goal" [milestone]="milestone" [stakeholder]="stakeholder"></goal-milestone-status>
          <ion-textarea autoGrow [readonly]="!canEdit" formControlName="content" placeholder="Type milestone" autocapitalize="sentences"></ion-textarea>
        </ion-item>
      </form>
    </section>

    <section class="deadline">
      <h6>Deadline</h6>
      <goal-milestone-deadline [milestone]="milestone" [stakeholder]="stakeholder" (deadlineChange)="updateDeadline($event)"></goal-milestone-deadline>
    </section>
    
    <ng-container *ngIf="goal.numberOfAchievers > 1">
      <section *ngIf="canEdit || milestone.achiever?.uid" class="assignee">
        <h6>Assignee</h6>
        <ng-container *ngIf="milestone.achiever?.uid else empty">
          <goal-milestone-assignee [achiever]="milestone.achiever!" (click)="toggleAssignMe()" [ngClass]="{'clickable': canEdit}"></goal-milestone-assignee>
        </ng-container>
        <ng-template #empty>
          <small (click)="toggleAssignMe()" class="clickable">
            <i >No one - Assign me</i>
          </small>
        </ng-template>
      </section>
    </ng-container>

    <section class="description">
      <ng-container *ngIf="!canEdit else editable">
        <ng-container *ngIf="milestone.description">
          <h6>Description</h6>
          <article>{{ milestone.description }}</article>
        </ng-container>
      </ng-container>
      <ng-template #editable>
        <h6>Description</h6>
        <ion-item lines="none">
          <ion-textarea [formControl]="form.description" placeholder="description" autocapitalize="sentences" [maxlength]="200" autoGrow></ion-textarea>
        </ion-item>
      </ng-template>
    </section>

    <section *ngIf="canEdit || milestone.subtasks?.length">
      <h6>Subtasks ({{ form.subtasks.value | subtasksCompleted}})</h6>
      <ion-list mode="md">
        <ion-reorder-group (ionItemReorder)="doReorder($event)" [disabled]="!canEdit">
          <ion-item *ngFor="let control of form.subtasks.controls; let i = index">
            <ion-button fill="clear" (click)="toggleSubtask(i)">
              <ion-icon  slot="icon-only"
                [name]="control.completed.value ? 'checkmark-circle' : 'radio-button-off'"
                color="primary">
              </ion-icon>
            </ion-button>
            <ion-input [readonly]="!canEdit" [formControl]="control.content" autocapitalize="sentences" (ionBlur)="subtaskBlur(i)"></ion-input>
            <ion-reorder slot="end"></ion-reorder>
          </ion-item>
        </ion-reorder-group>
        
        <form [formGroup]="subtaskForm" *ngIf="canEdit">
          <ion-item lines="none">
            <ion-icon class="icon" name="radio-button-off" color="primary"></ion-icon>
            <ion-input formControlName="content" placeholder="Add subtask" (keydown.enter)="addSubtask()" autocapitalize="sentences"></ion-input>
            <ion-button color="primary" (click)="addSubtask()">add</ion-button>
          </ion-item>
        </form>
      </ion-list>
    </section>

    <section class="support">
      <h6>Supports</h6>
      <article>
        <div (click)="openSupportModal()">
          <ng-container *ngIf="milestone.supports?.length else noSupports">
            <span>{{ milestone.supports.length }} {{ milestone.supports.length === 1 ? 'support' : 'supports' }}</span>
          </ng-container>
          <ng-template #noSupports>
            <i>no supports</i>
          </ng-template>
        </div>

        <ion-button (click)="openSupportModal()" class="secondary">
          <ion-icon slot="start" src="assets/icons/hand-holding-heart-solid.svg"></ion-icon>
          <span>{{ milestone.status === 'pending' ? 'SUPPORT' : 'ADD SUPPORT'}}</span>
        </ion-button>
      </article>
    </section>

    <ng-container *ngIf="story$ | async as story">
      <section *ngIf="canEdit || story.length">
        <h6>Story</h6>
        <goal-story [story]="story" [stakeholder]="stakeholder" [goalId]="goal.id" [milestoneId]="milestone.id"></goal-story>
      </section>
    </ng-container>

    <!-- <small><b>Created at:</b> {{ milestone.createdAt | date:'longDate' }}</small>
    <small *ngIf="milestone.finishedAt">
      <b>Finished at:</b> {{ milestone.finishedAt | date:'longDate' }}
    </small> -->

  </main>
</ion-content>

