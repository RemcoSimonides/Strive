<ng-container *ngIf="notification | message:'user' as _message">
  <section fxLayout fxLayoutGap="8px">
    <article>
      <img
        class="source_image"
        [ref]="_message.image"
        [asset]="(_message.link | source) === 'user' ? 'profile.png' : 'goal.jpeg'"
        [ngStyle]="{'border-radius': (_message.link | source) === 'user' ? '50%' : '12px'}"
        [routerLink]="_message.link"
      />
    </article>
    <article fxLayout="column" fxFlex fxLayoutGap="4px">
      <div fxLayout fxLayoutAlign="space-between start">
        <h5 [routerLink]="_message.link">{{ _message.title }}</h5>
        <p class="date">{{ notification.createdAt.toDate() | date:'M/d' }}</p>
      </div>
      <span>
        <ng-container *ngFor="let message of _message.message">
          <ng-container *ngIf="message.link; else noLink">
            <a [routerLink]="'/' + message.link">{{ message.text }}</a>
          </ng-container>
          <ng-template #noLink>
            {{ message.text }}
          </ng-template>
        </ng-container>
      </span>

      <!-- Goal Request to join action buttons -->
      <ng-container *ngIf="notification.meta?.type === 'goalRequest'">
        <div fxLayout>
          <ion-button (click)="handleRequestDecision(notification, true)"
              [disabled]="notification.meta.status !== 'open'"
              *ngIf="notification.meta.status !== 'rejected'">Accept</ion-button>
            <ion-button (click)="handleRequestDecision(notification, false)"
              [disabled]="notification.meta.status !== 'open'"
              *ngIf="notification.meta.status !== 'accepted'">Reject</ion-button>
        </div>
      </ng-container>

      <!-- Post -->
      <ng-container *ngIf="!!notification.source.postId">
        <strive-post [postRef]="'Goals/' + notification.source.goal.id + '/Posts/' + notification.source.postId"></strive-post>
      </ng-container>

      <!-- Supports -->
      <ng-container *ngIf="notification.meta?.type === 'supportDecision' && notification.meta.supports.length > 0">
        <b>Your supports:</b>
        <ng-container *ngFor="let support of notification.meta.supports">
          <div fxLayout>
            <div fxFlex fxLayoutAlign="start center">
              {{ support.finished ? support.description : support.description + ' (unfinished milestone)' }}
            </div>
            <div fxFlex fxLayoutAlign="start center">
              <ng-container *ngIf="!support.receiver.uid; else hasReceiver">
                <span class="clickable" (click)="chooseReceiver(notification, support)">
                  <i>Choose receiver</i>
                </span>
              </ng-container>
              <ng-template #hasReceiver>
                <div fxLayout fxLayoutAlign="center" (click)="removeReceiver(notification, support)">
                  <ion-chip>
                    <ion-avatar>
                      <img [ref]="support.receiver.photoURL" asset="profile.png" />
                    </ion-avatar>
                    <ion-label>{{ support.receiver.username }}</ion-label>
                  </ion-chip>
                </div>
              </ng-template>
            </div>
          </div>
        </ng-container>

        <!-- Buttons to accept or decline evidence -->
        <ion-button color="primary"
          (click)="finalizeDecision(notification)"
          [disabled]="notification.meta.status !== 'pending'"
          class="support_decision_btn"
        >Finalize
        </ion-button>

      </ng-container>

      <!-- Discussion -->
      <section fxLayout>
        <ion-button (click)="openDiscussion()" fill="clear">
          {{ (notification.discussion$ | async)?.numberOfComments || 0 }}
          <ion-icon id="discussion-icon" name="chatbox-outline"></ion-icon>
        </ion-button>
      </section>
    </article>
  </section>

</ng-container>