<strive-header-root [title]="user.uid ? 'Goals' : ''"></strive-header-root>

<ng-container *ngIf="(user.uid$ | async) !== undefined else loading">
  <ng-container *ngIf="!!user.uid else notLoggedIn">
    <ion-content class="ion-padding">

      <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
        <ion-refresher-content></ion-refresher-content>
      </ion-refresher>

      <!-- Goals -->
      <main>
        <ng-container *ngIf="stakeholders$ | async as stakeholders; else loading">
          <ng-container *ngIf="hasGoals$ | async else noGoals">

            <!-- <ng-container *ngIf="(stakeholders | currentFocus) as inFocus"> -->
              <!-- <ng-container *ngIf="inFocus.length; else noFocus">
                <header>
                  <h4 *ngIf="hasGoalsOutsideFocus$ | async">Current Focus</h4>
                  <ion-button fill="clear" (click)="createGoal()">
                    <ion-icon name="add" slot="start"></ion-icon>
                    <span>add goal</span>
                  </ion-button>      
                </header>

                <section>
                  <ng-container *ngFor="let stakeholder of inFocus; trackBy: trackByFn">
                    <ng-container *ngTemplateOutlet="goal; context: { $implicit: stakeholder }" ></ng-container>
                  </ng-container>
                </section>
              </ng-container>
              <ng-template #noFocus> -->
                <header>
                  <ion-button fill="clear" (click)="createGoal()">
                    <ion-icon name="add" slot="start"></ion-icon>
                    <span>add goal</span>
                  </ion-button>
        
                  <ion-button fill="clear" (click)="openOptions($event)">
                    <ion-icon slot="icon-only" name="options-outline"></ion-icon>
                  </ion-button>
                </header>
              <!-- </ng-template> -->
            <!-- </ng-container> -->

            <!-- <ng-container *ngIf="(stakeholders | currentFocus:true) as outsideFocus"> -->
              <!-- <ng-container *ngIf="hasGoalsOutsideFocus$ | async"> -->
                <!-- <header *ngIf="hasGoalsInFocus$ | async" class="other-goals">
                  <h4>All Goals</h4>
                  <ion-button fill="clear" (click)="openOptions($event)">
                    <ion-icon slot="icon-only" name="options-outline"></ion-icon>
                  </ion-button>
                </header>  -->

                <section class="cards">
                  <ng-container *ngFor="let stakeholder of stakeholders; trackBy: trackByFn">
                    <ng-container *ngTemplateOutlet="goal; context: { $implicit: stakeholder }" ></ng-container>
                  </ng-container>
                </section>
              <!-- </ng-container> -->
            <!-- </ng-container> -->

          </ng-container>

          <ng-template #noGoals>
            <header>
              <ion-button fill="clear" (click)="createGoal()">
                <ion-icon name="add" slot="start"></ion-icon>
                <span>add goal</span>
              </ion-button>      
            </header>
            <span class="padding">No goals yet. Create your first.</span>
          </ng-template>
        </ng-container>

      </main>
    </ion-content>
  </ng-container>
</ng-container>

<ng-template #goal let-stakeholder>
  <ion-card mode="md" [routerLink]="['/goal/', stakeholder.goal.id]">
    
    <section>
      <ion-thumbnail>
        <img [ref]="stakeholder.goal.image" asset="goal.png"/>
        <div *ngIf="stakeholder.goal.isFinished">finished</div>
      </ion-thumbnail>
      <article>
        <b>{{ stakeholder.goal.title }}</b>
        <small *ngIf="stakeholder.isAchiever && !stakeholder.isSupporter">{{ stakeholder.goal | toProgressLabel }}</small>
        <small *ngIf="stakeholder.isAchiever && stakeholder.isSupporter">{{ stakeholder.goal | toProgressLabel }} & Supporting</small>
        <small *ngIf="!stakeholder.isAchiever && stakeholder.isSupporter">Supporting</small>
        <ion-progress-bar color="primary" [value]="stakeholder.goal | progress"></ion-progress-bar>
      </article>
      <ion-button fill="clear" size="small" (click)="openGoalOptions(stakeholder.goal, stakeholder, $event)">
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
      <ul *ngIf="stakeholder.story.length" [routerLink]="['/goal/', stakeholder.goal.id]">
        <li *ngFor="let event of stakeholder.story">
          <ion-icon [name]="event.icon"></ion-icon>
          <span [ngClass]="{'important': event.importance <= 2}">{{ event.message }}</span>
        </li>
      </ul>
    </section>

  </ion-card>
</ng-template>

<ng-template #notLoggedIn>
  <journal-home></journal-home>
</ng-template>

<ng-template #loading>
  <strive-page-loading></strive-page-loading>
</ng-template>