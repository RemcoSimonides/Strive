<strive-header-root [title]="user.uid ? 'Goals' : 'Home'"></strive-header-root>

<ng-container *ngIf="(user.uid$ | async) !== undefined else loading">
  <ng-container *ngIf="!!user.uid else notLoggedIn">
    <ion-content class="ion-padding">

      <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
        <ion-refresher-content></ion-refresher-content>
      </ion-refresher>

      <!-- Goals -->
      <main>
        <header>
          <ion-button fill="clear" (click)="createGoal()">
            <ion-icon name="add" slot="start"></ion-icon>
            <span>add goal</span>
          </ion-button>

          <ion-button fill="clear" (click)="openOptions($event)">
            <ion-icon slot="icon-only" name="options-outline"></ion-icon>
          </ion-button>
        </header>

        <ng-container *ngIf="stakeholders$ | async as stakeholders; else loading">
          <ng-container *ngIf="stakeholders.length > 0 else noGoals">

            <section>
              <ng-container *ngFor="let stakeholder of stakeholders; trackBy: trackByFn">
                <ion-card>
                  <ion-item lines="none" [routerLink]="['/goal/', stakeholder.goal.id]">
                    <ion-thumbnail slot="start" [ngClass]="{'gradient-border': stakeholder.status === 'active'}">
                      <img [ref]="stakeholder.goal.image" asset="goal.jpeg"/>
                      <div *ngIf="stakeholder.status === 'finished'">finished</div>
                    </ion-thumbnail>
                    <article>
                      <ion-text>
                        <b>{{ stakeholder.goal.title }}</b>
                        <small fxLayout fxLayoutGap="4px">
                          <ion-icon name="pulse"></ion-icon><span>{{ stakeholder.status | status }}</span>
                          <ion-icon name="flag-outline"></ion-icon><span>{{ stakeholder.goal.numberOfAchievers }} Achiever{stakeholder.goal.numberOfAchievers, plural, =1 {} other {s}}</span>
                        </small>
                      </ion-text>
                      <ion-button fill="clear" (click)="openGoalOptions(stakeholder.goal, stakeholder, $event)">
                        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
                      </ion-button>
                    </article>
                  </ion-item>
                  <ul *ngIf="stakeholder.story.length" [routerLink]="['/goal/', stakeholder.goal.id]" [queryParams]="{t:'story'}">
                    <li *ngFor="let event of stakeholder.story">
                      <ion-icon [name]="event.icon"></ion-icon>
                      <span [ngClass]="{'important': event.importance <= 2}">{{ event.message }}</span>
                    </li>
                  </ul>
                </ion-card>
              </ng-container>
            </section>

          </ng-container>
          <ng-template #noGoals>
            <section *ngIf="form.allFalse; else reallyNoGoals" class="no-roles">
              <h4>Nothing to show because you deselected all roles</h4>
              <ion-list mode="md">
                <h5>Please select a role</h5>
                <form [formGroup]="form">
                  <ion-item>
                    <ion-checkbox formControlName="isAchiever" slot="start" color="primary"></ion-checkbox>
                    <ion-label>Achiever</ion-label>
                  </ion-item>
                  <ion-item>
                    <ion-checkbox formControlName="isSupporter" slot="start" color="primary"></ion-checkbox>
                    <ion-label>Supporter</ion-label>
                  </ion-item>
                  <ion-item lines="none">
                    <ion-checkbox formControlName="isAdmin" slot="start" color="primary"></ion-checkbox>
                    <ion-label>Admin</ion-label>
                  </ion-item>
                </form>
              </ion-list>
            </section>
            <ng-template #reallyNoGoals>
              <span class="padding">No goals yet. Create your first.</span>
            </ng-template>
          </ng-template>
        </ng-container>

      </main>
    </ion-content>
  </ng-container>
</ng-container>


<ng-template #notLoggedIn>
  <journal-home></journal-home>
</ng-template>

<ng-template #loading>
  <strive-page-loading></strive-page-loading>
</ng-template>