<ng-container *ngIf="goal$ | async as goal">
  <h1>{{ goal.title }}</h1>

  <section fxLayout fxLayout.lt-sm="column" fxLayoutGap="16px">
    <article fxLayout="column" fxFlex fxFlexOrder.lt-sm="2">
      <picture>
        <img [ref]="goal.image" asset="goal.jpeg" [width]="500" [height]="500"/>
        <div *ngIf="goal.status === 'finished'">finished</div>
      </picture>
    </article>

    <article fxLayout="column" fxLayoutGap="16px" fxFlex fxFlexOrder.lt-sm="1">
      <ion-card fxLayout fxLayoutAlign="space-evenly" class="team">
        <article fxLayout="column" fxLayoutGap="16px" fxLayoutAlign="center center">
          <ion-button (click)="join()" color="primary" fill="outline" [disabled]="goal.status === 'finished' || hasOpenRequestToJoin">
            <ion-icon slot="start" name="flag"></ion-icon>
            <span> {{ getJoinText() }}</span>
          </ion-button>
          <div fxLayout="column" fxLayoutAlign="start center" (click)="openTeamModal()">
            <strong>Achievers</strong>
            <span class="number">{{ goal.numberOfAchievers || '0' }}</span>
          </div>
        </article>
        <article fxLayout="column" fxLayoutGap="16px" fxLayoutAlign="center center">
          <ion-button (click)="supportGoal()" color="secondary" fill="outline">
            <fa-icon slot="start" [icon]="['fas', 'hand-holding-heart']"></fa-icon>
            <span> support</span>
          </ion-button>
          <div fxLayout="column" fxLayoutAlign="start center" (click)="openTeamModal()">
            <strong>Supporters</strong>
            <span class="number">{{ goal.numberOfSupporters || '0' }}</span>
          </div>
        </article>
      </ion-card>

      <!-- Options -->

      <ng-container *ngIf="(screensize.isMobile$ | async) === false">
        <div fxLayout="row wrap" fxLayoutAlign="space-between" fxLayoutGap="16px">
          <ion-button (click)="openDiscussion()" fill="clear">
            <ion-icon slot="start" name="chatbox-outline"></ion-icon>
            <span>chat</span>
          </ion-button>
  
          <ng-container *ngIf="goal.publicity === 'public' || isAdmin">
            <ion-button (click)="openSharePopover($event, goal)" fill="clear">
              <ion-icon slot="start" name="share-social-outline"></ion-icon>
              <span>share</span>
            </ion-button>
          </ng-container>
          <ion-button (click)="presentGoalOptionsPopover($event, goal)" fill="clear" *ngIf="isAdmin">
            <span>more options</span>
          </ion-button>
        </div>
      </ng-container>

      <div fxHide.lt-sm>
        <ng-container *ngTemplateOutlet="properties"></ng-container>
      </div>

    </article>

    <ng-container *ngIf="screensize.isMobile$ | async">
      <div fxLayout="row wrap" fxLayoutAlign="end" fxLayoutGap="4px" fxFlexOrder.lt-sm="3">
        <ion-button (click)="openDiscussion()" class="ion-no-padding action-button" fill="clear">
          <ion-icon slot="icon-only" name="chatbox-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="openSharePopover($event, goal)" fill="clear" size="small" class="ion-no-padding action-button">
          <ion-icon slot="icon-only" name="share-social-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="presentGoalOptionsPopover($event, goal)" fill="clear" class="ion-no-padding action-button" *ngIf="isAdmin">
          <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
        </ion-button>
      </div>
    </ng-container>

    <article fxHide.gt-xs fxFlexOrder="4">
      <ng-container *ngTemplateOutlet="properties"></ng-container>
    </article>
  </section>

  <!-- Request to join -->
  <ng-container *ngIf="openRequests$ | async as stakeholders">
    <ng-container *ngIf="stakeholders.length">
      <h3>Open requests to join</h3>
      <ion-list mode="md">
        <ion-item *ngFor="let stakeholder of stakeholders; let last = last" [lines]="last ? 'none' : 'inset'" (click)="navTo(stakeholder.uid)">
          <ion-avatar slot="start">
            <img [ref]="stakeholder.photoURL" asset="profile.png"/>
          </ion-avatar>
          <ion-label>{{ stakeholder.username }}</ion-label>
          <ion-button (click)="handleRequestDecision(stakeholder, true, $event)" size="default">
            <span *ngIf="(screensize.isMobile$ | async) === false">Accept</span>
            <ion-icon name="checkmark-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="handleRequestDecision(stakeholder, false, $event)" size="default" fill="outline">
            <span *ngIf="(screensize.isMobile$ | async) === false">Reject</span>
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>
    </ng-container>
  </ng-container>


  <strive-text-editor [description]="goal.description"
    [isAdmin]="isAdmin"
    (update)="saveDescription($event)"
  ></strive-text-editor>

  <section fxLayout>
    <ion-button fill="clear" (click)="segmentChange.next('roadmap')">
      see roadmap
    </ion-button>
    <ion-button fill="clear" (click)="segmentChange.next('story')">
      see story
    </ion-button>
  </section>

  <ng-template #properties>
    <article class="properties" fxLayout="column" fxLayoutGap="24px">
      <!-- Status -->
      <div fxLayout fxLayoutAlign="start center">
        <ion-icon name="pulse"></ion-icon>
        <span>Status: </span>
        <ng-container *ngIf="stakeholder$ | async as stakeholder; else statusNoAchiever">
          <ng-container *ngIf="stakeholder.isAchiever; else statusNoAchiever">
            <ion-select placeholder="Select Status" interface="popover" [value]="stakeholder.status" (ionChange)="updateStatus($event, goal)">
              <ion-select-option value="bucketlist">In Future</ion-select-option>
              <ion-select-option value="active">Current Focus</ion-select-option>
              <ion-select-option value="finished">Finished</ion-select-option>
            </ion-select>
          </ng-container>
        </ng-container>
        <ng-template #statusNoAchiever>
          <b>&nbsp;{{ goal.status | titlecase }}</b>
        </ng-template>
      </div>
  
      <!-- Privacy -->
      <div fxLayout fxLayoutAlign="start center">
        <ion-icon [name]="goal.publicity === 'public' ? 'lock-open-outline' : 'lock-closed-outline'"></ion-icon>
        <span>Access: </span>
        <ng-container *ngIf="isAdmin; else privacyNoAdmin">
          <ion-select placeholder="Select Privacy" interface="popover" [value]="goal.publicity" (ionChange)="updatePrivacy($event, goal)">
            <ion-select-option value="public">Everyone can access</ion-select-option>
            <ion-select-option value="private">Invites only</ion-select-option>
          </ion-select>
        </ng-container>
        <ng-template #privacyNoAdmin>
          <span>&nbsp;<b>{{ goal.publicity === 'public' ? 'Everyone can access' : 'Invites only' }}</b></span>
        </ng-template>
      </div>
  
      <!-- Deadline -->
      <ng-container *ngIf="!!goal.deadline">
        <div fxLayout fxLayoutAlign="start center" [ngStyle]="{ 'color': isOverdue(goal.deadline) ? 'var(--ion-color-danger-tint)' : 'inherit'}">
          <ion-icon name="timer-outline"></ion-icon>
          <span>Deadline: <b>{{ goal.deadline | date:'fullDate' }}</b></span>
        </div>
      </ng-container>
  
    </article>
  </ng-template>

</ng-container>
