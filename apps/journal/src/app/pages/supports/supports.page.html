<strive-header-root title="Supports"></strive-header-root>

<ng-container *ngIf="user.uid === undefined">
  <strive-page-loading></strive-page-loading>
</ng-container>

<ng-container *ngIf="user.uid === ''">
  <div class="not-logged-in">
    <p>
      <span class="fat-text-button" (click)="openAuthModal()">Log in</span>to view your supports
    </p>
  </div>  
</ng-container>

<ion-content class="ion-padding" *ngIf="!!user.uid">
  <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <main>

    <section *ngIf="supportsNeedDecision$ | async as goals">
      <ng-container *ngIf="goals.length">
        <ng-container *ngFor="let goal of goals">

          <ng-container *ngIf="goal.supports.length; else milestones">
            <ion-list mode="md">
              <ion-text class="list-header">Goal "<a [routerLink]="['/goal', goal.id]">{{ goal.title }}</a>" has been finished.</ion-text>

              <ion-item *ngFor="let support of goal.supports; let last = last" [lines]="last ? 'none' : 'inset'">
                <ion-label class="ion-text-wrap">
                  <ion-text>
                    <b>{{ support.description }}</b>
                    <ng-container *ngIf="support.source.milestone?.id">
                      <br/>
                      <small>{{ support.source.milestone.content }}</small>
                    </ng-container>
                  </ion-text>
                </ion-label>
                <ion-button color="primary" (click)="give(support)">
                  Give
                </ion-button>
                <ion-button fill="outline" (click)="reject(support)">
                  Reject
                </ion-button>
              </ion-item>

            </ion-list>
          </ng-container>

          <ng-template #milestones>
            <ng-container *ngFor="let milestone of goal.milestones">
              <ion-list mode="md">
                <ion-text class="list-header">Milestone "{{ milestone.content }}" of goal "<a [routerLink]="['/goal', goal.id]">{{ goal.title }}</a>" has been completed</ion-text>

                <ion-item *ngFor="let support of milestone.supports; let last = last" [lines]="last ? 'none' : 'inset'">
                  <ion-label class="ion-text-wrap">
                    <ion-text><b>{{ support.description }}</b></ion-text>
                  </ion-label>
                  <ion-button color="primary" (click)="give(support)">
                    Give
                  </ion-button>
                  <ion-button fill="outline" (click)="reject(support)">
                    Reject
                  </ion-button>
                </ion-item>
              </ion-list>
            </ng-container>
          </ng-template>
        </ng-container>

      </ng-container>
    </section>

    <h2>Goals you support</h2>
    <ion-list mode="md">
      <ng-container *ngIf="supportsOpen$ | async as supports">
        <ng-container *ngIf="supports.length else notSupportingGoals">
          <ng-container *ngFor="let support of supports; let last = last">
            <ion-item [lines]="last ? 'none' : 'inset'">
              <ion-label class="ion-text-wrap">
                <ion-text>{{ support.description }}</ion-text>
                <ng-template [ngTemplateOutlet]="path" [ngTemplateOutletContext]="{ $implicit: support }"></ng-template>
              </ion-label>
              <ion-button fill="clear" (click)="openOptions(support, $event)">
                <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
              </ion-button>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #notSupportingGoals>
          <ion-item>Not supporting any goals yet</ion-item>
        </ng-template>
      </ng-container>
    </ion-list>
      
    <h2>Support to get</h2>
    <ion-list mode="md">
      <ng-container *ngIf="supportsToGet$ | async as supports">
        <ng-container *ngIf="supports.length else noSupportsToGet">
          <ng-container *ngFor="let support of supports; let last = last">
            <ion-item [lines]="last ? 'none' : 'inset'">
              <ion-label>
                <ion-text>
                  {{ support.description }} from <a [routerLink]="['/profile', support.source.receiver.uid]">{{ support.source.supporter.username }}</a>
                </ion-text>
                <ng-template [ngTemplateOutlet]="path" [ngTemplateOutletContext]="{ $implicit: support }">
                </ng-template>
              </ion-label>
              <ion-button fill="outline" slot="end" (click)="supportPaid(support)">Got it</ion-button>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #noSupportsToGet>
          <ion-item lines="none">-</ion-item>
        </ng-template>
      </ng-container>
    </ion-list>

    <h2>Supports to give</h2>
    <ion-list mode="md">
      <ng-container *ngIf="supportsToGive$ | async as supports">
        <ng-container *ngIf="supports.length else noSupportsToGive">
          <ng-container *ngFor="let support of supports; let last = last">
            <ion-item [lines]="last ? 'none' : 'inset'">
              <ion-label>
                <ion-text>
                  {{ support.description }} to <a [routerLink]="['/profile', support.source.receiver.uid]">{{ support.source.receiver.username }}</a>
                </ion-text>
                <ng-template [ngTemplateOutlet]="path" [ngTemplateOutletContext]="{ $implicit: support }"></ng-template>
              </ion-label>
              <ion-button fill="outline" slot="end" (click)="supportPaid(support)">Gave it</ion-button>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #noSupportsToGive>
          <ion-item lines="none">-</ion-item>
        </ng-template>
      </ng-container>
    </ion-list>

    <h2>Supports gotten</h2>
    <ion-list mode="md">
      <ng-container *ngIf="supportsGotten$ | async as supports">
        <ng-container *ngIf="supports.length else noSupportsGotten">
          <ng-container *ngFor="let support of supports; let last = last">
            <ion-item [lines]="last ? 'none' : 'inset'">
              <ion-label>
                <ion-text>
                  {{ support.description }} from <a [routerLink]="['/profile', support.source.supporter.uid]">{{ support.source.supporter.username }}</a>
                </ion-text>
                <ng-template [ngTemplateOutlet]="path" [ngTemplateOutletContext]="{ $implicit: support }"></ng-template>
              </ion-label>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #noSupportsGotten>
          <ion-item lines="none">-</ion-item>
        </ng-template>
      </ng-container>
    </ion-list>

    <h2>Supports given</h2>
    <ion-list mode="md">
      <ng-container *ngIf="supportsGiven$ | async as supports">
        <ng-container *ngIf="supports.length else noSupportsGiven">
          <ng-container *ngFor="let support of supports; let last = last">
            <ion-item [lines]="last ? 'none' : 'inset'">
              <ion-label>
                <ion-text>
                  {{ support.description }} to achiever(s) from {{ support.source.goal.title }}
                </ion-text>
                <ng-template [ngTemplateOutlet]="path" [ngTemplateOutletContext]="{ $implicit: support }"></ng-template>
              </ion-label>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #noSupportsGiven>
          <ion-item lines="none">-</ion-item>
        </ng-template>
      </ng-container>
    </ion-list>

  </main>
</ion-content>

<ng-template #path let-support>
  <ion-text>
    <p *ngIf="!support.source.milestone?.id"><a [routerLink]="'../goal/' + (support.source.goal.id)">{{ support.source.goal.title }}</a></p>
    <p *ngIf="support.source.milestone?.id"><a [routerLink]="'../goal/' + (support.source.goal.id)">{{ support.source.goal.title | mSlice}}</a>&nbsp;<span class="arrow">&#8702;</span> {{ support.source.milestone.content | mSlice }}</p>
  </ion-text>
</ng-template>