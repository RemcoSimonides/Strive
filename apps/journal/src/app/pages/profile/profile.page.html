<ion-header *ngIf="screensize.isMobile$ | async">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>{{ !!profileId ? (profile$ | async)?.username : 'Profile'  }}</ion-title>
    <ng-container *ngIf="isOwner$ | async">
      <ion-buttons slot="end">
        <ion-button routerLink="/settings">
          <ion-icon slot="icon-only" name="settings"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ng-container>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-no-padding">
  <ng-template #loading>
    <ng-container *ngIf="!!profileId else login">
      <strive-page-loading></strive-page-loading>
    </ng-container>

    <ng-template #login>
      <section class="not-logged-in">
        <p>
            <span class="fat-text-button" (click)="openAuthModal()">Log in</span>to view your profile
        </p>
      </section>
   </ng-template>
  </ng-template>

  <ng-container *ngIf="profile$ | async as profile; else loading">
    <section fxLayout fxLayoutAlign="center" class="header">

      <!-- HEADER -->
      <ion-card>
        <article fxLayout="column" fxLayoutAlign="space-between" fxLayoutGap="12px">
          <div fxLayout fxLayoutAlign="center center" fxLayoutGap="12px">
            <h4>{{ profile.username }}</h4>
          </div>

          <article fxLayout fxLayoutAlign="space-evenly">
            <div fxLayout="column" fxLayoutAlign="center center" (click)="openFollowers()">
              <p>Followers</p>
              <span>{{ profile.numberOfSpectators }}</span>
            </div>
            <div fxLayout="column" fxLayoutAlign="center center" (click)="openFollowing()">
              <p>Following</p>
              <span>{{ profile.numberOfSpectating }}</span>
            </div>
          </article>
  
          <ng-container *ngIf="(isOwner$ | async) === false">
            <ng-container *ngIf="isSpectator$ | async else notSpectator">
              <ion-button (click)="toggleSpectate(false)" fill="outline">Stop Following</ion-button>
            </ng-container>
            <ng-template #notSpectator>
              <ion-button (click)="toggleSpectate(true)" fill="outline">Follow</ion-button>
            </ng-template>
          </ng-container>
        </article>

      </ion-card>
      <article fxLayout fxLayoutAlign="center end" class="img-container">
        <img [ref]="profile.photoURL" asset="profile.png" alt="profile picture"/>
      </article>
    </section>

    <section fxLayout="column">
      <article fxLayout fxLayoutAlign="space-between end" fxLayoutGap="8px">
        <h2>Bucket List</h2>
        <ion-button *ngIf="isOwner$ | async" fill="clear" (click)="createGoal()">
          <ion-icon name="add" slot="start"></ion-icon>
          <span>add goal</span>
        </ion-button>
      </article>
      <ng-container *ngIf="achievingGoals$ | async as achievingGoals">
        <ng-container *ngIf="achievingGoals.length > 0 else noBucketList">
          <ion-list mode="md">
            <ng-container *ngFor="let value of achievingGoals; let last = last">
              <ion-item [lines]="last ? 'none' : 'inset'" button [routerLink]="['/goal/', value.goal.id]">
                <ion-thumbnail slot="start" [ngClass]="{'gradient-border': value.stakeholder.status === 'active'}">
                  <img [ref]="value.goal.image" asset="goal.jpeg"/>
                  <div *ngIf="value.stakeholder.status === 'finished'">finished</div>
                </ion-thumbnail>
                <article>
                  <ion-label fxLayout="column">
                    <b>{{ value.goal.title }}</b>
                    <small fxLayout fxLayoutGap="4px">
                      <ion-icon name="pulse"></ion-icon><span>{{ value.stakeholder.status | status }}</span>
                      <ion-icon name="flag-outline"></ion-icon><span>{{ value.goal.numberOfAchievers }} Achiever{value.goal.numberOfAchievers, plural, =1 {} other {s}}</span>
                    </small>
                  </ion-label>
                  <ion-button *ngIf="isOwner$ | async" fill="clear" (click)="openGoalOptions(value.goal, value.stakeholder, $event)">
                    <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
                  </ion-button>
                </article>
              </ion-item>
            </ng-container>
          </ion-list>
        </ng-container>
        <ng-template #noBucketList>
          <span class="padding">Not achieving any goals</span>
        </ng-template>
      </ng-container>
    </section>

    <!-- Supporting Goals overview -->
    <section fxLayout="column">
      <h2>Supporting Goals</h2>
      <ng-container *ngIf="supportingGoals$ | async as supportingGoals">
        <ng-container *ngIf="supportingGoals.length > 0 else noSupportingGoals">
          <ion-list mode="md">
            <ng-container *ngFor="let goal of supportingGoals; let last = last">
              <ion-item [lines]="last ? 'none' : 'inset'" button [routerLink]="['/goal/', goal.id]">
                <ion-thumbnail slot="start">
                  <img [ref]="goal.image" asset="goal.jpeg"/>
                  <div *ngIf="goal.status === 'finished'">finished</div>
                </ion-thumbnail>
                <article>
                  <ion-label fxLayout="column">
                    <b>{{ goal.title }}</b>
                    <small fxLayout fxLayoutGap="4px">
                      <ion-icon name="flag-outline"></ion-icon><span>{{ goal.numberOfAchievers }} Achiever{goal.numberOfAchievers, plural, =1 {} other {s}}</span>
                      <fa-icon [icon]="['fas', 'hand-holding-heart']" slot="end"></fa-icon><span>{{ goal.numberOfSupporters }} Supporter{goal.numberOfSupporters, plural, =1 {} other {s}}</span>
                    </small>
                  </ion-label>
                </article>
              </ion-item>
            </ng-container>
          </ion-list>
        </ng-container>
        <ng-template #noSupportingGoals>
          <span class="padding">Not supporting any goals</span>
        </ng-template>
      </ng-container>
    </section>

    <ng-container *ngIf="isOwner$ | async as isOwner">
      <section fxLayout="column">
        <h5>Only you see the content below</h5>

        <!-- Exercises -->
        <h2>Exercises</h2>

        <article class="grid">
          <ng-container *ngFor="let exercise of exercises">
            <strive-small-thumbnail [title]="exercise.title" [asset]="exercise.image" [routerLink]="exercise.link">
            </strive-small-thumbnail>
          </ng-container>
        </article>

      </section>
    </ng-container>
  </ng-container>

  <footer></footer>
</ion-content>